name: Update WakaTime Stats SVG

on:
  schedule:
    - cron: "0 */12 * * *" # every 12 hours
  workflow_dispatch:

  push:
    branches:
    - main

permissions:
  contents: write

jobs:
  generate-stats:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generate SVG from Vercel API
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p wakatime
          curl -fsSL "https://wakatime-readme-stats.vercel.app/api/wakatimeStats?username=$GITHUB_ACTOR&api_key=$WAKATIME_API_KEY&github_token=$GITHUB_TOKEN&theme=dark_github&components=2&title_prefix=_____%27s&border_width=2&border_radius=10&scale=true&component1_scale_value=1.5&component1_type=weekly_langs&component1_chart_type=area&component1_start_day=mo&component1_y_axis=true&component1_y_axis_label=true&border_color=DD2BC7" \
            -o wakatime/waka-stats.svg

      - name: Bump README cache-buster for wakatime/stats.svg (daily)
        run: |
          set -euo pipefail

          V="$(date -u +%Y%m%d)"  # changes once per day

          sed -i -E "s#(wakatime/waka-stats\.svg)\?v=[0-9]+#\1?v=$V#g" README.md
          sed -i -E "s#(wakatime/waka-stats\.svg)(\"|')#\1?v=$V\2#g" README.md

      # the content will be available at https://raw.githubusercontent.com/<github_user>/<repository>/<target_branch>/<file> , or as github page
      - name: Push to media branch
        uses: crazy-max/ghaction-github-pages@v2.6.0
        with:
          target_branch: media
          build_dir: wakatime
          keep_history: true 
          commit_message: Update wakatime stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
